name: Build domains
on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *"
  push:
    branches:
      - master
    paths-ignore:
      - "**/README.md"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set variables
        run: |
          echo "update_version=$(date -d '+8 hours' +%Y-%m-%d)" >> ${GITHUB_ENV}
        shell: bash

      - name: Checkout codebase
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ./go.mod

      - name: Checkout v2fly/domain-list-community
        uses: actions/checkout@v4
        with:
          repository: v2fly/domain-list-community
          path: community

      - name: Checkout cokebar/gfwlist2dnsmasq
        uses: actions/checkout@v4
        with:
          repository: cokebar/gfwlist2dnsmasq
          path: gfwlist2dnsmasq

      - name: Append attribute domains
        run: |
          echo "include:geolocation-cn @!cn" >> ./community/data/geolocation-\!cn
          echo "include:geolocation-!cn @cn" >> ./community/data/cn

      - name: Generate `mihomo` geosite.dat and domains (.txt files)
        run: |
          go run ./ --datapath=./community/data/

      - name: Download and Process Rules
        run: |
          mkdir -p ./tmp/ ./domains/
                    
          # [A] 標準 YAML 規則集 (格式: "名稱|URL")
          src_yaml=(
            "private|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Lan/Lan.yaml"
            "hulu|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Hulu/Hulu.yaml"
            "telegram|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Telegram/Telegram.yaml"
            "youtubemusic|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/YouTubeMusic/YouTubeMusic.yaml"
            "twitter|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Twitter/Twitter.yaml"
            "github|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/GitHub/GitHub.yaml"
            "gitlab|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/GitLab/GitLab.yaml"
            "cloudflare|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Cloudflare/Cloudflare.yaml"
            "binance|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Binance/Binance.yaml"
            "douyin|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/DouYin/DouYin.yaml"
            "duolingo|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Duolingo/Duolingo.yaml"
            "facebook|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Facebook/Facebook.yaml"
            "instagram|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Instagram/Instagram.yaml"
            "shopee|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Shopee/Shopee.yaml"
            "wechat|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/WeChat/WeChat.yaml"
            "applenews|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/AppleNews/AppleNews.yaml"
            "applemusic|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/AppleMusic/AppleMusic.yaml"
            "apple_classical|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Apple/Apple_Classical.yaml"
            "google|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Google/Google.yaml"
            "truthSocial|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/TruthSocial/TruthSocial.yaml"
          )

          # [B] 標準 LIST 規則集 (格式: "名稱|URL")
          src_list=(
            "netflix|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Netflix/Netflix.list"
            "disney|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Disney/Disney.list"
            "max|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/HBO/HBO.list"
            "primevideo|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/PrimeVideo/PrimeVideo.list"
            "appletv|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/AppleTV/AppleTV.list"
            "youtube|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/YouTube/YouTube.list"
            "tiktok|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/TikTok/TikTok.list"
            "bilibili|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/BiliBili/BiliBili.list"
            "spotify|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Spotify/Spotify.list"
          )

          # [C] 特殊處理源 (Special Handling Sources)
          url_fakeip="https://raw.githubusercontent.com/DustinWin/ShellCrash/dev/public/fake_ip_filter.list"
          url_ads="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Advertising/Advertising_Classical.yaml"
          url_adobe="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Adobe/Adobe.list"
          url_media="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/GlobalMedia/GlobalMedia.list"
          url_networktest="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Speedtest/Speedtest.list"
          url_proxy="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Global/Global.list"
          url_cn_max="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/ChinaMax/ChinaMax.list"
          url_cn_lite="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/China/China.list" # Used for cn-lite

          # 需要合併的列表 (Grouped Sources)
          src_trackers=(
            "https://raw.githubusercontent.com/XIU2/TrackersListCollection/master/all.txt"
            "https://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_all.txt"
          )
          src_apps=(
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Download/Download.list"
            "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/applications.txt"
          )
          src_cn_conf=(
            "apple|https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/apple.china.conf"
            "google|https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/google.china.conf"
          )
          src_games_cn=(
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN.list"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Game/GameDownloadCN/GameDownloadCN.list"
          )
          src_games_gl=(
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Game/Game.list"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Game/GameDownload/GameDownload.list"
          )
          src_ai=(
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/OpenAI/OpenAI.list"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Copilot/Copilot.list"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Gemini/Gemini.list"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Claude/Claude.list"
          )

          # 處理標準 YAML 
          process_yaml() {
            local name=$1
            local url=$2
            echo "Processing YAML: ${name}..."
            local content
            content=$(curl -sSL "$url" | sed -n '/payload:/,$p' | sed -E "s/^\s*-\s*'?(.*?)'?$/\1/")
            
            echo "$content" | awk '/^DOMAIN-SUFFIX,/' | sed 's/DOMAIN-SUFFIX,//' > "./tmp/temp-${name}-suffix.txt"
            if [ -f "./publish/${name}.txt" ]; then perl -ne '/^(domain):([^:]+)(\n$|:@.+)/ && print "$2\n"' "./publish/${name}.txt" >> "./tmp/temp-${name}-suffix.txt"; fi
            sort --ignore-case -u "./tmp/temp-${name}-suffix.txt" > "./tmp/${name}-suffix.txt"
            
            echo "$content" | awk '/^DOMAIN,|^DOMAIN-KEYWORD,|^PROCESS-NAME,/' > "./tmp/temp-${name}-other.txt"
            if [ -f "./publish/${name}.txt" ]; then perl -ne '/^(full):([^:]+)(\n$|:@.+)/ && print "DOMAIN,$2\n"' "./publish/${name}.txt" >> "./tmp/temp-${name}-other.txt"; fi
            sort --ignore-case -u "./tmp/temp-${name}-other.txt" > "./tmp/${name}-other.txt"
          }

          # 處理標準 List 
          process_list() {
             local name=$1
             local url=$2
             echo "Processing List: ${name}..."
             perl -ne '/^(domain):([^:]+)(\n$|:@.+)/ && print "$2\n"' "./publish/${name}.txt" > "./tmp/temp-${name}-suffix.txt" 2>/dev/null || touch "./tmp/temp-${name}-suffix.txt"
             curl -sSL "$url" | awk '/^DOMAIN-SUFFIX,/' | sed 's/DOMAIN-SUFFIX,//' >> "./tmp/temp-${name}-suffix.txt"
             sort --ignore-case -u "./tmp/temp-${name}-suffix.txt" > "./tmp/${name}-suffix.txt"
             
             perl -ne '/^(full):([^:]+)(\n$|:@.+)/ && print "DOMAIN,$2\n"' "./publish/${name}.txt" > "./tmp/temp-${name}-other.txt" 2>/dev/null || touch "./tmp/temp-${name}-other.txt"
             curl -sSL "$url" | awk '/^DOMAIN,/' >> "./tmp/temp-${name}-other.txt"
             sort --ignore-case -u "./tmp/temp-${name}-other.txt" > "./tmp/${name}-other.txt"
          }

          # A. 批量處理標準源
          for item in "${src_yaml[@]}"; do
            process_yaml "${item%%|*}" "${item##*|}"
          done

          for item in "${src_list[@]}"; do
             process_list "${item%%|*}" "${item##*|}"
          done

          # B. 處理 FakeIP
          echo "Processing FakeIP..."
          curl -sSL "$url_fakeip" | perl -ne '/^[\+\*]\.([^\*]+)\n$/ && print "$1\n"' | sort --ignore-case > ./tmp/fakeip-filter-suffix.txt
          curl -sSL "$url_fakeip" | awk '!/[#+* ]/' | sed 's/^/DOMAIN,/' > ./tmp/temp-fakeip-filter-other.txt
          curl -sSL "$url_fakeip" | awk '/\*/ && !/#/ && !/\./' | sed -e 's/\*/\[\^\.\]\+/g' -e 's/^/DOMAIN-REGEX,\^/; s/$/\$/' >> ./tmp/temp-fakeip-filter-other.txt
          curl -sSL "$url_fakeip" | awk '!/#/ && (/\.\*/ || / /)' | sed -e 's/ /\\s/g' -e 's/\./\\./g' -e 's/\*/\[\^\.\]\+/g' -e 's/^\+/\.\*/' -e 's/^/DOMAIN-REGEX,\^/; s/$/\$/' >> ./tmp/temp-fakeip-filter-other.txt
          sort --ignore-case ./tmp/temp-fakeip-filter-other.txt > ./tmp/fakeip-filter-other.txt

          # Fakeip-filter-lite
          cat <<EOF > ./tmp/temp-fakeip-filter-lite.txt
          DOMAIN,adguardteam.github.io
          DOMAIN,adrules.top
          DOMAIN,anti-ad.net
          DOMAIN,local.adguard.org
          DOMAIN,static.adtidy.org
          EOF
          curl -sSL "$url_fakeip" | awk '!/[#+* ]/ && /ntp|stun|time/' | sed 's/^/DOMAIN,/' >> ./tmp/temp-fakeip-filter-lite.txt
          curl -sSL "$url_fakeip" | awk '/ntp|stun|time/' | perl -ne '/^[\+\*]\.([^\*]+)\n$/ && print "DOMAIN-SUFFIX,$1\n"' >> ./tmp/temp-fakeip-filter-lite.txt
          curl -sSL "$url_fakeip" | awk '/ntp|stun|time/ && /\.\*/' | sed -e 's/\./\\./g' -e 's/\*/\[\^\.\]\+/g' -e 's/^\+/\.\*/' -e 's/^/DOMAIN-REGEX,\^/; s/$/\$/' >> ./tmp/temp-fakeip-filter-lite.txt
          sort --ignore-case ./tmp/temp-fakeip-filter-lite.txt > ./domains/fakeip-filter-lite.list

          # C. 處理特殊源 (Ads, Trackers, Apps, Adobe, Media, Proxy)
          echo "Processing Ads..."
          curl -sSL "$url_ads" | sed -n '/payload:/,$p' | sed -E "s/^\s*-\s*'?(.*?)'?$/\1/" | awk '/^DOMAIN,|^DOMAIN-SUFFIX,|^DOMAIN-KEYWORD,|^PROCESS-NAME,/' | sort --ignore-case > ./domains/ads.list
          curl -sSL "$url_ads" | sed -n '/payload:/,$p' | sed -E "s/^\s*-\s*'?(.*?)'?$/\1/" | awk '/^IP-CIDR,|^IP-CIDR6,/' | sort --ignore-case > ./domains/adsip.list

          echo "Processing Trackers..."
          > ./tmp/temp-trackerslist.txt
          for url in "${src_trackers[@]}"; do
             curl -sSL "$url" | grep -i '\.[A-Z]' | awk -F '[/:]' '{print $4}' | sed 's/^/DOMAIN,/' >> ./tmp/temp-trackerslist.txt
          done
          sort --ignore-case -u ./tmp/temp-trackerslist.txt > ./domains/trackerslist.list

          echo "Processing Applications..."
          curl -sSL "${src_apps[0]}" | awk '/^DOMAIN,|^DOMAIN-SUFFIX,|^DOMAIN-KEYWORD,|^PROCESS-NAME,/' > ./tmp/temp-applications.txt
          curl -sSL "${src_apps[1]}" | perl -ne '/^\s*-\s+(.*)/ && print "$1\n"' >> ./tmp/temp-applications.txt
          sort --ignore-case -u ./tmp/temp-applications.txt > ./domains/applications.list

          echo "Processing Adobe..."
          if [ -f "./publish/adobe.txt" ]; then perl -ne '/^(domain):([^:]+)(\n$|:@.+)/ && print "$2\n"' "./publish/adobe.txt" > ./tmp/temp-adobe-suffix.txt; fi
          curl -sSL "$url_adobe" | awk '/^DOMAIN-SUFFIX,/' | sed 's/DOMAIN-SUFFIX,//' >> ./tmp/temp-adobe-suffix.txt
          sort --ignore-case -u ./tmp/temp-adobe-suffix.txt > ./tmp/adobe-suffix.txt
          if [ -f "./publish/adobe.txt" ]; then perl -ne '/^(full):([^:]+)(\n$|:@.+)/ && print "DOMAIN,$2\n"' "./publish/adobe.txt" > ./tmp/temp-adobe-other.txt; fi
          curl -sSL "$url_adobe" | awk '/^DOMAIN,/' >> ./tmp/temp-adobe-other.txt
          sort --ignore-case -u ./tmp/temp-adobe-other.txt > ./tmp/adobe-other.txt

          echo "Processing Media..."
          curl -sSL "$url_media" | awk '/^DOMAIN,|^DOMAIN-SUFFIX,/' | sort --ignore-case > ./domains/media.list
          
          echo "Processing Proxy..."
          chmod +x ./gfwlist2dnsmasq/gfwlist2dnsmasq.sh
          ./gfwlist2dnsmasq/gfwlist2dnsmasq.sh -l -o ./tmp/temp-gfw.txt
          cat ./tmp/temp-gfw.txt | sed 's/^/DOMAIN-SUFFIX,/' | sort --ignore-case > ./domains/gfw.list
          
          cp -f ./tmp/temp-gfw.txt ./tmp/temp-proxy-suffix.txt
          perl -ne '/^(domain):([^:]+)(\n$|:@.+)/ && print "$2\n"' ./publish/geolocation-\!cn.txt >> ./tmp/temp-proxy-suffix.txt 2>/dev/null || true
          curl -sSL "$url_proxy" | awk '/^DOMAIN-SUFFIX,/' | sed 's/DOMAIN-SUFFIX,//' >> ./tmp/temp-proxy-suffix.txt
          sort --ignore-case -u ./tmp/temp-proxy-suffix.txt > ./tmp/proxy-suffix.txt
          perl -ne '/^(full):([^:]+)(\n$|:@.+)/ && print "DOMAIN,$2\n"' ./publish/geolocation-\!cn.txt > ./tmp/temp-proxy-other.txt 2>/dev/null || true
          curl -sSL "$url_proxy" | awk '/^DOMAIN,/' >> ./tmp/temp-proxy-other.txt
          sort --ignore-case -u ./tmp/temp-proxy-other.txt > ./tmp/proxy-other.txt

          # D. 處理 CN, Games, AI, Networktest
          echo "Processing CN Domains (Microsoft/Apple/Google)..."
          # Apple & Google CN
          for item in "${src_cn_conf[@]}"; do
             name="${item%%|*}"; url="${item##*|}"
             perl -ne '/^(domain):([^:]+):@cn/ && print "$2\n"' "./publish/${name}.txt" > "./tmp/${name}-cn-suffix.txt" 2>/dev/null || touch "./tmp/${name}-cn-suffix.txt"
             perl -ne '/^(full):([^:]+):@cn/ && print "DOMAIN,$2\n"' "./publish/${name}.txt" > "./tmp/temp-${name}-cn-other.txt" 2>/dev/null || touch "./tmp/temp-${name}-cn-other.txt"
             curl -sSL "$url" | perl -ne '/server=\/([^\/]+)/ && print "DOMAIN,$1\n"' >> "./tmp/temp-${name}-cn-other.txt"
             sort --ignore-case -u "./tmp/temp-${name}-cn-other.txt" > "./tmp/${name}-cn-other.txt"
          done
          # Microsoft CN
          perl -ne '/^(domain):([^:]+):@cn/ && print "$2\n"' ./publish/microsoft.txt > ./tmp/microsoft-cn-suffix.txt 2>/dev/null || touch ./tmp/microsoft-cn-suffix.txt
          perl -ne '/^(full):([^:]+):@cn/ && print "DOMAIN,$2\n"' ./publish/microsoft.txt > ./tmp/microsoft-cn-other.txt 2>/dev/null || touch ./tmp/microsoft-cn-other.txt

          echo "Processing Games CN..."
          perl -ne '/^(domain):([^:]+)(\n$|:@.+)/ && print "$2\n"' ./publish/category-game-accelerator-cn.txt > ./tmp/temp-games-cn-suffix.txt 2>/dev/null || true
          perl -ne '/^(domain):([^:]+):@cn/ && print "$2\n"' ./publish/category-game-platforms-download.txt >> ./tmp/temp-games-cn-suffix.txt 2>/dev/null || true
          perl -ne '/^(domain):([^:]+)(\n$|:@.+)/ && print "$2\n"' ./publish/category-games-cn.txt >> ./tmp/temp-games-cn-suffix.txt 2>/dev/null || true
          for url in "${src_games_cn[@]}"; do
            curl -sSL "$url" | awk '/^DOMAIN-SUFFIX,/' | sed 's/DOMAIN-SUFFIX,//' >> ./tmp/temp-games-cn-suffix.txt
          done
          sort --ignore-case -u ./tmp/temp-games-cn-suffix.txt > ./tmp/games-cn-suffix.txt
          
          perl -ne '/^(full):([^:]+)(\n$|:@.+)/ && print "DOMAIN,$2\n"' ./publish/category-game-accelerator-cn.txt > ./tmp/temp-games-cn-other.txt 2>/dev/null || true
          perl -ne '/^(full):([^:]+):@cn/ && print "DOMAIN,$2\n"' ./publish/category-game-platforms-download.txt >> ./tmp/temp-games-cn-other.txt 2>/dev/null || true
          perl -ne '/^(full):([^:]+)(\n$|:@.+)/ && print "DOMAIN,$2\n"' ./publish/category-games-cn.txt >> ./tmp/temp-games-cn-other.txt 2>/dev/null || true
          for url in "${src_games_cn[@]}"; do
            curl -sSL "$url" | awk '/^DOMAIN,/' >> ./tmp/temp-games-cn-other.txt
          done
          sort --ignore-case -u ./tmp/temp-games-cn-other.txt > ./tmp/games-cn-other.txt

          echo "Processing Games Global..."
          chmod +x ./tools/removeFrom.py
          perl -ne '/^(domain):([^:]+)(\n$|:@!cn)/ && print "$2\n"' ./publish/category-game-platforms-download.txt > ./tmp/temp-games-suffix.txt 2>/dev/null || true
          perl -ne '/^(domain):([^:]+)(\n$|:@!cn)/ && print "$2\n"' ./publish/category-games-\!cn.txt >> ./tmp/temp-games-suffix.txt 2>/dev/null || true
          > ./tmp/games-with-cn-suffix-unsort.txt
          for url in "${src_games_gl[@]}"; do
            curl -sSL "$url" | awk '/^DOMAIN-SUFFIX,/' | sed 's/DOMAIN-SUFFIX,//' >> ./tmp/games-with-cn-suffix-unsort.txt
          done
          sort --ignore-case -u ./tmp/games-with-cn-suffix-unsort.txt > ./tmp/games-with-cn-suffix.txt
          # Remove CN games from Global games
          > ./tmp/games-cn-suffix-deleted-unsort.txt
          for url in "${src_games_cn[@]}"; do
            curl -sSL "$url" | awk '/^DOMAIN-SUFFIX,/' | sed 's/DOMAIN-SUFFIX,//' >> ./tmp/games-cn-suffix-deleted-unsort.txt
          done
          sort --ignore-case -u ./tmp/games-cn-suffix-deleted-unsort.txt > ./tmp/games-cn-suffix-deleted.txt
          python ./tools/removeFrom.py -remove ./tmp/games-cn-suffix-deleted.txt -from ./tmp/games-with-cn-suffix.txt -out ./tmp/games-without-cn-suffix.txt
          cat ./tmp/games-without-cn-suffix.txt >> ./tmp/temp-games-suffix.txt
          sort --ignore-case -u ./tmp/temp-games-suffix.txt > ./tmp/games-suffix.txt
          
          perl -ne '/^(full):([^:]+)(\n$|:@!cn)/ && print "DOMAIN,$2\n"' ./publish/category-game-platforms-download.txt > ./tmp/temp-games-other.txt 2>/dev/null || true
          perl -ne '/^(full):([^:]+)(\n$|:@!cn)/ && print "DOMAIN,$2\n"' ./publish/category-games-\!cn.txt >> ./tmp/temp-games-other.txt 2>/dev/null || true
          > ./tmp/games-with-cn-other-unsort.txt
          for url in "${src_games_gl[@]}"; do
             curl -sSL "$url" | awk '/^DOMAIN,/' >> ./tmp/games-with-cn-other-unsort.txt
          done
          sort --ignore-case -u ./tmp/games-with-cn-other-unsort.txt > ./tmp/games-with-cn-other.txt
          > ./tmp/games-cn-other-deleted-unsort.txt
          for url in "${src_games_cn[@]}"; do
             curl -sSL "$url" | awk '/^DOMAIN,/' >> ./tmp/games-cn-other-deleted-unsort.txt
          done
          sort --ignore-case -u ./tmp/games-cn-other-deleted-unsort.txt > ./tmp/games-cn-other-deleted.txt
          python ./tools/removeFrom.py -remove ./tmp/games-cn-other-deleted.txt -from ./tmp/games-with-cn-other.txt -out ./tmp/games-without-cn-other.txt
          cat ./tmp/games-without-cn-other.txt >> ./tmp/temp-games-other.txt
          sort --ignore-case -u ./tmp/temp-games-other.txt > ./tmp/games-other.txt

          echo "Processing AI..."
          perl -ne '/^(domain):([^:]+)(\n$|:@.+)/ && print "$2\n"' ./publish/category-ai-\!cn.txt > ./tmp/temp-ai-suffix.txt 2>/dev/null || true
          for ai_url in "${src_ai[@]}"; do
            curl -sSL "$ai_url" | awk '/^DOMAIN-SUFFIX,/' | sed 's/DOMAIN-SUFFIX,//' >> ./tmp/temp-ai-suffix.txt
          done
          sort --ignore-case -u ./tmp/temp-ai-suffix.txt > ./tmp/ai-suffix.txt
          perl -ne '/^(full):([^:]+)(\n$|:@.+)/ && print "DOMAIN,$2\n"' ./publish/category-ai-\!cn.txt > ./tmp/temp-ai-other.txt 2>/dev/null || true
          for ai_url in "${src_ai[@]}"; do
             curl -sSL "$ai_url" | awk '/^DOMAIN,/' >> ./tmp/temp-ai-other.txt
          done
          sort --ignore-case -u ./tmp/temp-ai-other.txt > ./tmp/ai-other.txt

          echo "Processing Networktest..."
          perl -ne '/^(domain):([^:]+)(\n$|:@.+)/ && print "$2\n"' ./publish/test-ipv6.txt > ./tmp/temp-networktest-suffix.txt 2>/dev/null || true
          perl -ne '/^(domain):([^:]+)(\n$|:@.+)/ && print "$2\n"' ./publish/category-speedtest.txt >> ./tmp/temp-networktest-suffix.txt 2>/dev/null || true
          curl -sSL "$url_networktest" | awk '/^DOMAIN-SUFFIX,/' | sed 's/DOMAIN-SUFFIX,//' >> ./tmp/temp-networktest-suffix.txt
          sort --ignore-case -u ./tmp/temp-networktest-suffix.txt > ./tmp/networktest-suffix.txt
          perl -ne '/^(full):([^:]+)(\n$|:@.+)/ && print "DOMAIN,$2\n"' ./publish/test-ipv6.txt > ./tmp/temp-networktest-other.txt 2>/dev/null || true
          perl -ne '/^(full):([^:]+)(\n$|:@.+)/ && print "DOMAIN,$2\n"' ./publish/category-speedtest.txt >> ./tmp/temp-networktest-other.txt 2>/dev/null || true
          curl -sSL "$url_networktest" | awk '/^DOMAIN,|^DOMAIN-KEYWORD,/' >> ./tmp/temp-networktest-other.txt
          sort --ignore-case -u ./tmp/temp-networktest-other.txt > ./tmp/networktest-other.txt

          echo "Processing TLD-Proxy..."
          perl -ne '/^(domain):([^:]+)(\n$|:@.+)/ && print "$2\n"' ./publish/tld-\!cn.txt > ./tmp/tld-proxy-suffix.txt 2>/dev/null || true
          perl -ne '/^(full):([^:]+)(\n$|:@.+)/ && print "DOMAIN,$2\n"' ./publish/tld-\!cn.txt > ./tmp/tld-proxy-other.txt 2>/dev/null || true

          echo "Processing CN & CN-Lite..."
          # CN
          perl -ne '/^(domain):([^:]+)(\n$|:@.+)/ && print "$2\n"' ./publish/cn.txt > ./tmp/temp-cn-suffix.txt 2>/dev/null || true
          curl -sSL "$url_cn_max" | awk '/^DOMAIN-SUFFIX,/' | sed 's/DOMAIN-SUFFIX,//' >> ./tmp/temp-cn-suffix.txt
          sort --ignore-case -u ./tmp/temp-cn-suffix.txt > ./tmp/cn-suffix.txt
          perl -ne '/^(full):([^:]+)(\n$|:@.+)/ && print "DOMAIN,$2\n"' ./publish/cn.txt > ./tmp/temp-cn-other.txt 2>/dev/null || true
          curl -sSL "$url_cn_max" | awk '/^DOMAIN,/' >> ./tmp/temp-cn-other.txt
          sort --ignore-case -u ./tmp/temp-cn-other.txt > ./tmp/cn-other.txt
          # CN-Lite
          perl -ne '/^(domain):([^:]+)(\n$|:@.+)/ && print "$2\n"' ./publish/cn.txt > ./tmp/temp-cn-lite-suffix.txt 2>/dev/null || true
          curl -sSL "$url_cn_lite" | awk '/^DOMAIN-SUFFIX,/' | sed 's/DOMAIN-SUFFIX,//' >> ./tmp/temp-cn-lite-suffix.txt
          sort --ignore-case -u ./tmp/temp-cn-lite-suffix.txt > ./tmp/cn-lite-suffix.txt
          perl -ne '/^(full):([^:]+)(\n$|:@.+)/ && print "DOMAIN,$2\n"' ./publish/cn.txt > ./tmp/temp-cn-lite-other.txt 2>/dev/null || true
          curl -sSL "$url_cn_lite" | awk '/^DOMAIN,/' >> ./tmp/temp-cn-lite-other.txt
          sort --ignore-case -u ./tmp/temp-cn-lite-other.txt > ./tmp/cn-lite-other.txt

      - name: Remove redundant domains
        run: |
          chmod +x ./tools/*.py ./tools/filter.sh
          archs=(fakeip-filter private microsoft-cn apple-cn google-cn games-cn netflix disney max primevideo appletv youtube tiktok bilibili spotify games ai networktest tld-proxy proxy cn cn-lite adobe applemusic applenews apple_classical google douyin duolingo facebook binance cloudflare shopee telegram truthSocial twitter wechat github gitlab hulu instagram youtubemusic)
          for arch in "${archs[@]}"; do
            python ./tools/findRedundantDomain.py "./tmp/${arch}-suffix.txt" "./tmp/${arch}-deleted-unsort-suffix.txt" 2>/dev/null || true
            [ ! -f "./tmp/${arch}-deleted-unsort-suffix.txt" ] && touch "./tmp/${arch}-deleted-unsort-suffix.txt"
            sort --ignore-case "./tmp/${arch}-deleted-unsort-suffix.txt" > "./tmp/${arch}-deleted-sort-suffix.txt"
            python ./tools/removeFrom.py -remove "./tmp/${arch}-deleted-sort-suffix.txt" -from "./tmp/${arch}-suffix.txt" -out "./tmp/none-redundant-${arch}-suffix.txt" 2>/dev/null || true
            cat "./tmp/none-redundant-${arch}-suffix.txt" 2>/dev/null | sed 's/^/DOMAIN-SUFFIX,/' > "./tmp/done-${arch}-suffix.txt"
            cat "./tmp/${arch}-other.txt" "./tmp/done-${arch}-suffix.txt" 2>/dev/null | sort --ignore-case -u > "./tmp/${arch}-redundant.txt"

            ./tools/filter.sh "./tmp/${arch}-redundant.txt" > "./domains/${arch}.list"
          done
          rm -rf ./tmp* ./publish*

      - name: Release and upload `domains` assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: domains
          tag: domains
          overwrite: true
          body: |
            供下游项目 [Yat-Muk/ruleset_geodata](https://github.com/Yat-Muk/ruleset_geodata) 使用的 DOMAIN 数据源文件
            文件更新于 ${{ env.update_version }}
          file_glob: true
          file: ./domains/*

      - name: Git push assets to `domains` branch
        run: |
          cd ./domains/ || exit 1
          git init
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b domains
          git add . && git commit -m "DOMAIN 数据源文件更新于 ${update_version}"
          git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f --set-upstream origin domains
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Purge jsDelivr CDN
        run: |
          cd ./domains/ || exit 1
          for file in $(ls); do
            curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@domains/${file}"
          done

      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 3
          keep_minimum_runs: 1
